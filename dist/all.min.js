"use strict";!function(){angular.module("cn.flex-form",["ui.router","schemaForm","ui.bootstrap.datetimepicker","cnTagsInput","cn.util"])}(),function(){function e(){function e(e){t.push(e)}function r(e){function r(){return _.chain(e).omit(t).omit(function(e){return _.isUndefined(e)||_.isNull(e)}).value()}return{getStateParams:r,ignoreParams:t}}r.$inject=["$stateParams"];var t=["page","debug","sandbox","modal","modalId"];return{addIgnoreParam:e,$get:r}}angular.module("cn.flex-form").provider("cnFlexFormConfig",e)}(),function(){function e(){return{restrict:"E",scope:{config:"=ffHeaderConfig",submit:"&ffSubmit",loadOffscreen:"&ffLoadOffscreen"},controller:r,bindToController:!0,controllerAs:"vm",template:'<div class="col-md-6">                  <h5 ng-if="vm.config.title.lead">{{::vm.config.title.lead}}</h5>                  <h1>{{vm.config.title.main}}</h1>                  <h5 ng-if="vm.config.title.sub">{{::vm.config.title.sub}}</h5>                </div>                <div class="{{vm.config.buttonContainerClass}}">                  <div class="btn-options"                       ng-mouseover="vm.loadOffscreen()">                    <a class="btn" ui-sref="{{vm.config.actionConfig.returnState}}">                      {{vm.config.actionConfig.returnText || \'Cancel\'}}                    </a>                    <span ng-repeat="button in vm.config.actionConfig.actions">                      <a class="btn {{button.style && \'btn-\'+button.style}}"                         ng-disabled="vm.isDisabled(button)"                         ng-class="{\'btn-primary\': $index === vm.config.actionConfig.actions.length - 1}"                         ng-click="vm.submit({ handler: button.handler})"                         tooltip="{{button.helptext}}"                         tooltip-placement="bottom">                        {{button.text || \'Save\'}}                      </a>                    </span>                  </div>                  <p class="data-updated-at text-right" id="data-updated-at">                    <a ng-click="vm.updateData()">Update Data</a>                  </p>                </div>                '}}function r(e){function r(){console.log("updateData:",r),e.$emit("ffRefreshData")}function t(e){return o.config.isDisabled?o.config.isDisabled(e):!1}var o=this;o.updateData=r,o.isDisabled=t}angular.module("cn.flex-form").directive("cnFlexFormHeader",e),r.$inject=["$scope"]}(),function(){function e(e,r,t,o){function a(){i.modal=e.open(i),i.modal.result["finally"](s),i.dismiss=t.$on("$stateChangeStart",n)}function s(){r.go("^")}function n(){i.dismiss(),i.modal.dismiss()}var i=this;console.log("FlexFormModalLoader:",o.modal),a()}function r(e,r,t){function o(){var o=e.getMapping(t.modal);return console.log("currentModal:",o),this.modal=r.open(o),this.modal}var a={open:o};return a}angular.module("cn.flex-form").controller("FlexFormModalLoader",e).factory("FlexFormModal",r),e.$inject=["FlexFormModal","$state","$rootScope","$stateParams"],r.$inject=["cnFlexFormModalLoaderService","$modal","$stateParams"]}(),function(){function e(e){var r=s[e];return r||(r={},s[e]=r),r}function r(r,t,o){var a=e(r),s=a[t];return s||(s=o.defer(),a[t]=s),s}function t(){function e(e,r){r.resolve={parent:t},a[e]=r}function t(e,t){return r(e.modal,e.modalId,t).promise}var s={addMapping:e,$get:o};return t.$inject=["$stateParams","$q"],s}function o(e){function t(t,o,a){r(t,o,e).resolve(a)}function o(e){return a[e]}var s={getMapping:o,resolveMapping:t};return s}angular.module("cn.flex-form").provider("cnFlexFormModalLoaderService",t);var a={},s={};o.$inject=["$q"]}(),function(){function e(){function e(e){t.unshift(e)}function r(){function e(e){for(var r=0,o=t.length;o>r;r++)if(t[r].condition(e))return t[r].type;return e.type||e.schema&&e.schema.type}return{fieldTypeRegister:t,getFieldType:e}}var t=[{condition:function(e){return"hidden"===e.type},type:"hidden"},{condition:function(e){return e.type.includes("radiobuttons")},type:"cn-radiobuttons"},{condition:function(e){return e.type.includes("autocomplete")||e.titleMap||e.titleMapResolve||e.titleMapQuery},type:"cn-autocomplete"},{condition:function(e){return"cn-datetimepicker"===e.type||"datetime-local"===e.type},type:"cn-datetimepicker"},{condition:function(e){return"help"===e.type},type:"help"},{condition:function(e){return e.type.includes("display")},type:"cn-display"},{condition:function(e){return e.schema&&e.schema.format&&e.schema.format.includes("currency")},type:"cn-currency"},{condition:function(e){return e.schema&&"percentage"===e.schema.format},type:"cn-percentage"},{condition:function(e){return"boolean"===e.type},type:"cn-toggle"},{condition:function(e){return"mediaupload"===e.type},type:"cn-mediaupload"},{condition:function(e){return"reusable"===e.type},type:"cn-reusable"},{condition:function(e){return"array"===e.type},type:"section"}];return{registerFieldType:e,$get:r}}angular.module("cn.flex-form").provider("cnFlexFormTypes",e)}(),function(){function e(){return{restrict:"A",scope:{form:"=ffValidate"},require:"ngModel",link:r}}function r(e,r,t,o){e.form&&e.form.required&&e.$watch(function(){return o.$viewValue},function(e){o.$setValidity("schemaForm",!0),o.$setValidity("tv4-302",e)})}angular.module("cn.flex-form").directive("ffValidate",e)}(),function(){function e(){return{restrict:"E",template:'        <div ng-if="vm.showForm()">          <ng-form name="{{vm.formName}}"                sf-schema="vm.config.schema.schema"                sf-form="vm.form"                sf-model="vm.model"></ng-form>          <!-- debug panel to display model -->          <pre ng-if="vm.debug">{{vm.model|json}}</pre>        </div>      ',scope:{config:"=ffConfig",model:"=ffModel",formIndex:"=ffFormIndex",formName:"=ffFormName",delayForm:"=ffDelayForm",cleanupEvent:"=ffCleanupEvent"},controller:r,controllerAs:"vm",bindToController:!0}}function r(e,r,t){function o(){angular.isNumber(c.formIndex)?c.form=c.config.schema.forms[c.formIndex].form:c.form=c.config.schema.form,t.search().debug&&(c.debug=!0)}function a(r,t){c.form&&(c.service?(console.log("vm.service.isCompiled():",c.service.isCompiled()),c.service.compile(c.config.schema,c.model)):c.service=e(c.config.schema,c.model,{formCtrl:c.config.formCtrl,getSchema:c.config.getSchema,updateSchema:n}))}function s(){return!c.delayForm&&c.service&&c.service.isCompiled()}function n(e){c.config.schema=e,c.activate()}function i(){_.each(c.events,function(e){e()}),c.service.cleanup()}var c=this;c.service=void 0,c.events=[],c.activate=o,c.cleanup=i,c.process=a,c.showForm=s,c.events.push(r.$watch(function(){return c.config.schema},c.process)),c.activate(),r.$on(c.cleanupEvent||"$destroy",c.cleanup)}angular.module("cn.flex-form").directive("cnFlexForm",e),r.$inject=["cnFlexFormService","$scope","$location"]}(),function(){function e(e){function r(){}function t(r){e.state(r.name+".page.modal",{url:"/~:modal/:modalId",controller:"FlexFormModalLoader",controllerAs:"vm",permissions:r.permissions})}var o={addStates:t,$get:r};return o}function r(e){e.state("flex-form-sandbox",{url:"/flex-form/sandbox",controller:"FlexFormSandbox",controllerAs:"vm",templateUrl:"app/components/cn-flex-form/sandbox.html"})}angular.module("cn.flex-form").provider("cnFlexFormRoutes",e).config(r),e.$inject=["$stateProvider"],r.$inject=["$stateProvider"]}(),function(){function cnFlexFormServiceProvider(e,r){function t(t){t.condition&&r.registerFieldType({condition:t.condition,type:t.type}),t.handler&&(fieldTypeHandlers[t.type]=t.handler),t.templateUrl&&(e.addMapping("bootstrapDecorator",t.type,t.templateUrl),e.createDirective(t.type,t.templateUrl))}return{registerField:t,$get:CNFlexFormService}}function CNFlexFormService(Api,$parse,cnFlexFormConfig,cnFlexFormTypes,$interpolate,$rootScope,$timeout,cnUtil){function CNFlexFormConstructor(e,r,t){var o;if(services.length)for(var a=0,s=services.length;s>a;a++)if(services[a].model===r){o=services[a],o.compile(e,r,t);break}return o||(o=new CNFlexForm(e,r,t),services.push(o)),o||new CNFlexForm(e,r,t)}function CNFlexForm(e,r,t){this.arrayCopies={},this.arrayListeners={},this.dataCache={},this.defaults={},this.errors=[],this.events=[],this.formCache={},this.listeners={},this.resolveRegister={},this.model=r,this.updates=0,this.params=cnFlexFormConfig.getStateParams(),this.compile(e,r,t)}function compile(e,r,t){var o=this;o.schema=e,o.model=r,o.isCompiled()||(o.setupConfig(t),e.forms?_.each(e.forms,function(e){_.each(e.form,o.processField.bind(o))}):_.each(e.form,o.processField.bind(o)),o.initModelWatch(),o.initArrayCopyWatch(),o.isCompiled(!0)),o.broadcastErrors()}function isCompiled(e){var r=this;return e&&(r.schema.compiled=e),r.schema&&r.schema.compiled}function setupConfig(e){var r=this;e&&(e.formCtrl&&(r.formCtrl=e.formCtrl),e.updateSchema&&(r.updateSchema=e.updateSchema),e.getSchema&&(r.getSchemaForm=r.setupSchemaRefresh(e.getSchema)))}function processSchema(e){var r=this,t=e.schema;t&&(e.getSchemaType=function(){return _.isArray(t.type)?_.first(t.type):t.type},r.processDefault(e))}function processDefault(e){var r=this,t=e.schema;if(t["default"]){var o=r.getKey(e.key);if(r.updates){if(o.includes&&o.includes("[]"))return;var a=r.parseExpression(e.key,r.model),s=a.get();(!r.defaults[o]||_.isUndefined(s)||angular.equals(s,r.defaults[o]))&&a.set(t["default"])}r.defaults[o]=angular.copy(t["default"])}}function processFieldset(e){var r=this;e.type="cn-fieldset",_.each(e.items,r.processField.bind(r)),e.collapsible?(e.toggleCollapse=function(){e.collapsible&&(e.collapsed=!e.collapsed)},e.render=!e.collapsed):e.render=!0}function processField(e){var r=this;if(e.selectDisplay&&r.processSelectDisplay(e,r.getSchema(e.key)),"fieldset"===e.type)r.processFieldset(e);else{e._ogKeys||(e._ogKeys=_.without(_.keys(e),"key"));var t=r.getKey(e.key);if(e.key&&(r.addToFormCache(e,t),e.schema=r.getSchema(t),e.schema&&(e.schema.description&&(e.description=e.schema.description),e.readonly&&!e.schema.readonly&&(e.readonly=!1))),r.processSchema(e),e.type||(e.type=e.getSchemaType&&e.getSchemaType()),e.resolve&&r.processResolve(e),e.watch&&r.processFieldWatch(e),"section"===e.type||"tabarray"===e.type)r.processSection(e);else if("component"===e.type)r.processComponent(e);else{var o=cnFlexFormTypes.getFieldType(e),a=fieldTypeHandlers[o];_.isString(a)?r[a](e):_.isFunction(a)&&a.call(r,e),e.updateSchema&&r.registerHandler(e,null,e.updateSchema),e.error&&r.errors.push(r.buildError(e))}}}function getKey(e){return _.isArray(e)&&(e=_.reduce(e,function(e,r){return/^(\d*)$/.test(r)?e+"["+r+"]":e+"."+r})),e}function getSchema(e,r){if(e){var t=this;e=t.getKey(e),e=e.replace(/arrayIndex/g,"").replace(/(\[')([^.]+)\.([^.]+)('])/g,".$2%ff_dt%$3").replace(/\./g,"%ff_sp%").replace(/%ff_dt%/g,".").split("%ff_sp%"),r=r||t.schema.schema.properties;for(var o,a;e.length>1;)o=e[0],a=o.match(/\[\d*]$/),r=a?r[e.shift().slice(0,o.length-a[0].length)].items.properties:r[e.shift()].properties;return o=e[0],a=o.match(/\[\d*]$/),a?r[o.slice(0,o.length-a[0].length)].items:r[o]}}function processResolve(e){var r=this;return _.each(e.resolve,function(t,o){r.handleResolve(e,o,t);var a=t.match(/^(schema\.data\.|model\.)(\w+)/);a&&("schema.data."===a[1]?r.registerResolve(e,o,a[2]):"model."===a[1]&&r.registerHandler(a[2],function(){r.handleResolve(e,o,t)}))}),e}function handleResolve(e,r,t){var o=this,a=o.parseExpression(t).get();a&&a.cursor?e.loadMore=function(){var e=t.match(/schema\.data\.(.+)/)[1];o.refreshSchema("data:"+e+":"+a.cursor)}:delete e.loadMore,e[r]=a&&a.data?a.data:a}function registerResolve(e,r,t){var o=this;o.resolveRegister[t]=o.resolveRegister[t]||{},o.resolveRegister[t][o.getKey(e.key)]={field:e,key:r}}function processFieldWatch(field){var service=this,schema=field.schema;field.watch=_.isArray(field.watch)?field.watch:[field.watch],_.each(field.watch,function(watch){if(watch.resolution){var condition=watch.condition,functionCondition=service.isConditionFunction(condition),resolution=watch.resolution,handler;if(_.isFunction(resolution))handler=function(){var e=functionCondition?service.parseCondition(functionCondition):condition;(!e||$parse(e)(service))&&resolution()};else{var adjustment={};adjustment.date=resolution.match(/\+ ?(\d+) days/),adjustment.date?(adjustment.date=adjustment.date[1],resolution=resolution.replace(adjustment.date,"").trim()):(adjustment.math=resolution.match(/(\+|\-|\/|\*) ?(\S+)/),adjustment.math&&(adjustment.operator={"+":"add","-":"subtract","*":"multiply","/":"divide"}[adjustment.math[1]],adjustment.adjuster=service.parseExpression(adjustment.math[2]))),resolution=resolution.match(/(\S+) ?= ?(\S+)/),handler=function handler(){var updatePath,fromPath;resolution[1].includes("arrayIndex")&&(updatePath=replaceArrayIndex(resolution[1],arguments[2])),resolution[2].includes("arrayIndex")&&(fromPath=replaceArrayIndex(resolution[2],arguments[2]));var update=service.parseExpression(updatePath||resolution[1]),from=service.parseExpression(fromPath||resolution[2]),parsedCondition=functionCondition?service.parseCondition(functionCondition):condition;if(!parsedCondition||$parse(parsedCondition)(service))if(adjustment.date)update.set(moment(from.get()).add(adjustment.date,"days").toDate());else if(adjustment.math){var result=eval(from.get()+adjustment.math[1]+adjustment.adjuster.get());if(schema=schema||field.items&&(field.items[0].schema||field.items[0].items&&field.items[0].items[0].schema),"cn-currency"===field.type){var p=schema&&"currency-dollars"===schema.format?2:0;result="*"===adjustment.math[1]?_.floor(result,p):"/"===adjustment.math[1]?_.ceil(result,p):_.round(result,p)}service.listeners[update.path().key].prev=result,update.set(result||0)}else update.set(from.get())}}service.registerHandler(field,handler,field.updateSchema)}})}function isConditionFunction(e){return e&&e.match(/(\!?)(.+)\((.+)\)/)}function parseCondition(e){var r=this,t=e[1],o=e[2],a=e[3];if("any"===o){var s=a.match(/(.+)\[\]\.*(.*)(===|>|<|>=|<=)(.+)/),n=r.parseExpression(s[1]).get(),i=s[3],c=s[4].trim().replace(/'/g,""),l=s[2].trim(),m=!1;return n.forEach(function(e){var r=l?e[l]:e;evaluatePredicate(r,i,c)&&(m=!0)}),t?(!m).toString():m.toString()}}function evaluatePredicate(e,r,t){switch(r){case"===":return e===t;case">=":return e>=t;case"<=":return t>=e;case">":return e>t;case"<":return t>e}}function registerHandler(e,r,t,o){var a=this;if(_.isObject(e)&&!_.isArray(e)){if(!e.key&&e.items)return void _.each(e.items,function(e){a.registerHandler(e,r,e.updateSchema)});e=e.key}e=a.getKey(e);var s=e.match(/([^[\]]*)\[]\.?(.+)/);if(s)return void a.registerArrayHandlers(s[1],s[2],r,t,o);if(!a.listeners[e]){var n=angular.copy(a.parseExpression(e,a.model).get());a.listeners[e]={handlers:[],updateSchema:t,prev:n}}r&&(a.listeners[e].handlers.push(r),o&&r(null,null,e))}function registerArrayHandlers(e,r,t,o,a){var s=this,n=function(n,i){var c,l,m;if(i&&i>n){var d=e+"["+(i-1)+"]."+r;if(s.listeners[d])for(c=0,l=i;l>c;c++)m=e+"["+c+"]."+r,s.deregisterHandlers(m);for(c=0,l=n;l>c;c++)m=e+"["+c+"]."+r,s.registerHandler(m,t,o),a&&t(null,null,m)}else if(n>(i||0))for(c=i,l=n;l>c;c++)m=e+"["+c+"]."+r,s.registerHandler(m,t,o),a&&t(null,null,m)},i=s.parseExpression(e,s.model).get();_.each(i,function(n,i){var c=e+"["+i+"]."+r;s.registerHandler(c,t,o),a&&t(null,null,c)}),s.arrayListeners[e+".length"]?s.arrayListeners[e+".length"].handlers.push(n):s.arrayListeners[e+".length"]={handlers:[n],prev:i?i.length:0}}function deregisterHandlers(e){var r=this;r.listeners[e]=void 0}function initModelWatch(){var e=this;e.watching||(e.modelWatch&&e.modelWatch(),e.modelWatch=$rootScope.$watch(function(){return e.model},e.onModelWatch.bind(e),!0),e.initSchemaParams(),e.watching=!0)}function onModelWatch(e,r){var t=this;angular.equals(e,r)||(cnUtil.cleanModel(t.model),t.prevParams=angular.copy(t.params),t.params={},_.each(t.arrayListeners,function(e,r){var o=t.parseExpression(r,t.model).get();angular.equals(o,e.prev)||(_.each(e.handlers,function(r){r(o,e.prev)}),e.prev=angular.copy(o))}),_.each(t.listeners,function(e,r){if(e){var o=t.parseExpression(r,t.model).get();angular.equals(o,e.prev)||(_.each(e.handlers,function(t){t(o,e.prev,r)}),e.prev=angular.copy(o)),e.updateSchema&&!angular.isUndefined(o)&&null!==o&&(t.params[r]=o)}}),angular.equals(t.params,t.prevParams)||(t.model.id&&!t.updates&&_.isEmpty(t.prevParams)?++t.updates:t.refreshSchema()))}function initSchemaParams(){var e=this;_.each(e.listeners,function(r,t){if(r){var o=e.parseExpression(t,e.model).get();r.updateSchema&&!angular.isUndefined(o)&&null!==o&&(e.params[t]=o)}})}function initArrayCopyWatch(){var e=this;e.events.push($rootScope.$on("schemaFormPropagateScope",function(r,t){var o=e.getKey(t.form.key),a=o.match(/^.*\[(\d+)].*$/);o=o.replace(/\[\d+]/g,"[]"),a=a&&parseInt(a[1]),t.form.condition||(t.form.condition="true"),e.addArrayCopy(t.form,o,a),t.$emit("flexFormArrayCopyAdded",o)})),e.events.push($rootScope.$on("schemaFormDeleteScope",function(r,t,o){console.log("schemaFormDeleteScope:",o,t.form,t);var a=e.getKey(t.form.key).replace(/\[\d+]/g,"[]"),s=e.getArrayCopiesFor(a);if(s.forEach(function(e){e.splice(o,1)}),t.form.link){var n=e.parseExpression(t.form.link,e.model).get();n.splice(o,1)}}))}function addArrayCopy(e,r,t){var o=this;(!t||0>t)&&(t=0),o.arrayCopies[r]||(o.arrayCopies[r]=[]),o.arrayCopies[r][t]=e}function getArrayCopies(e){var r=this;return r.arrayCopies[e]}function getArrayCopiesFor(e){var r=this,t=[];return e+="[]",_.each(r.arrayCopies,function(r,o){o.includes(e)&&t.push(r)}),t}function addToFormCache(e,r){var t=this;r=r||t.getKey(e.key),t.getFromFormCache(r)||(t.formCache[r]=e)}function getFromFormCache(e){var r=this;return r.formCache[e]}function addToDataCache(e,r){var t=this;e&&(t.dataCache[e]=r)}function getFromDataCache(e){var r=this;return r.dataCache[e]}function parseExpression(exp,depth){var service=this;if(!exp||/^(null|false|true|undefined|''|[0-9.]+|\[]|\{})$/.test(exp))return{get:function get(){return eval(exp)}};exp=service.getKey(exp);var match=exp.match(/^(model\.)?(\S+)$/),modelValue={get:function(){for(var e=exp.replace(/\[]/g,"").replace(/\[(\d+)]/g,".$1").split("."),r=depth||service;r&&e.length>1;)r=r[e.shift()];return r&&r[e[0]]},set:function(e){for(var r=exp.replace(/\[]/g,"").replace(/\[(\d+)]/g,".$1").split("."),t=depth||service;t&&r.length>1;){var o=r.shift();t[o]||(/^\d?$/.test(r[0])?t[o]=[]:t[o]={}),t=t[o]}return t[r[0]]=e,e},path:function(){return{exp:exp,depth:depth,key:match[2]}}};return modelValue}function processSection(e){var r=this;_.each(e.items,r.processField.bind(r))}function processComponent(e){var r=this;e.type="section",e.htmlClass="row";var t=12/_.reject(e.items,"hidden").length;_.each(e.items,function(o,a){r.processField(o),e.items[a]={type:"section",htmlClass:"col-sm-"+t,items:[o]}})}function processCurrency(e){e.currencyFormat={"currency-dollars":"dollars","currency-microcents":"microcents",currency:"cents"}[e.schema.format],e.type="cn-currency"}function processPercentage(e){e.type="cn-percentage"}function processReusable(e){var r=this;e.type="cn-reusable",e.view=e.view||"new",e.items.forEach(r.processField.bind(r)),e.items=[{type:"section",items:e.items,condition:"!model."+r.getKey(e.key)+".id"}]}function processMediaUpload(e){var r=this;e.type="cn-mediaupload",_.each(e.data,function(t,o){e.data[o]=r.parseExpression(t).get()})}function processRadiobuttons(e){e.type="cn-radiobuttons",e.fullWidth&&(e.btnClass="col-sm-"+_.divide(12,e.titleMap.length))}function processDate(e){e.type="cn-datetimepicker"}function processSelect(e){var r=this,t=e.schema;if((e.titleMapResolve||e.titleMap)&&(e.getTitleMap=function(){return e.titleMap||r.schema.data[e.titleMapResolve]},e.onInit=function(t,o,a,s){var n=r.parseExpression(o.key,r.model);if(t=n.get(),"tag-init"===a){var i;if("array"===o.schema.type)"object"!==o.schema.items.type&&(i=[],_.each(t,function(r){var t={};t[e.valueProperty||"value"]=r,i.push(_.find(e.getTitleMap(),t))}));else{var c={};c[e.valueProperty||"value"]=t,i=_.find(e.getTitleMap(),c)}i&&s(i)}}),e.titleMapQuery){var o=e.titleMapQuery.params.q;e.titleQuery=function(r){console.log("titleMap:",r);var t={};return o&&(t[o]=r),Api.get({url:e.titleMapQuery.url,params:t})},o||(e.minLookup="0"),e.onInit=function(e,r,t,o){"tag-init"===t&&o(e)}}if(t.items){var a=[];_.each(t.items.properties,function(e,r){angular.isDefined(e["default"])&&a.push({key:r,"default":e["default"]})}),a.length&&(e.onAdd=function(e,r,t){e.value&&"tag-added"===t&&_.each(a,function(r){e.value[r.key]||(e.value[r.key]=r["default"])})})}e.type.includes("cn-autocomplete")||(e.items?(e.detailedList=!0,"component"!==e.items[0].type&&(e.items.length>1&&(e.items=[{type:"component",items:e.items}]),r.processFieldset(e)),e.type="cn-autocomplete-detailed"):(e.selectionStyle||("tags"===e.key?e.selectionStyle="tags":"array"===e.getSchemaType()&&1!==e.schema.maxItems?e.selectionStyle="list":e.selectionStyle="select"),e.type="cn-autocomplete")),e.displayFormat&&(e.itemFormatter=r.processTemplate(e.displayFormat)),r.registerHandler(e.key,function(t){var o=r.formCtrl&&r.formCtrl[r.getKey(e.key)];o&&o.$setDirty&&o.$setDirty()},e.updateSchema)}function processToggle(e){e.type="cn-toggle"}function processHelp(e){e.htmlClass="help-block"}function processDisplay(e){var r=this;e.type="cn-display",e.getDisplay=r.processTemplate(e.displayFormat,!0)}function processTemplate(e,r){var t=this,o=$interpolate;return function(a,s){return r&&(angular.isDefined(s)&&(a=_.map(a,function(e){return"arrayIndex"===e?s:e})),a=t.parseExpression(a,t.model).get()),o(e)(a)}}function processSelectDisplay(e,r){var t,o=this,a=_.find(e.items,"selectField");t=r&&"array"===r.type?setupArraySelectDisplay(e,a,o):setupSelectDisplay(e,a,o),e.selectDisplay=!1,o.registerHandler(a.key,t,a.updateSchema,!0),o.processField(e)}function setupArraySelectDisplay(e,r,t){_.each(e.items,function(e){"false"!==e.condition&&(e.condition="true")});var o=function(){var o=getArrayIndex(arguments[2]);_.each(e.items,function(e){var a=t.getKey(r.key),s=t.getKey(e.key),n=ObjectPath.parse(s);if(a!==s){var i=t.setArrayIndex(a,o),c=t.parseExpression(i,t.model).get(),l=t.getArrayCopies(s);_.includes(c,n[n.length-1])?_.each(l,function(e){getArrayIndex(e)==o&&(e.condition="true")}):_.each(l,function(e){getArrayIndex(e)==o&&(e.condition="false",t.parseExpression(t.getKey(e.key),t.model).set())})}})},a=t.parseExpression(t.getKey(e.key),t.model).get();_.each(e.items,function(e){var o=t.getKey(e.key),s=t.getKey(r.key);o!==s&&_.each(a,function(e,r){var a=t.setArrayIndex(o,r),n=ObjectPath.parse(a),i=t.setArrayIndex(s,r),c=t.parseExpression(i,t.model),l=c.get(),m=t.parseExpression(a,t.model).get();m&&!_.includes(l,n[n.length-1])&&(l||(l=[]),l.push(n[n.length-1]),c.set(l))})});var s=t.getSchema(e.key)["default"];_.each(s,function(e,o){var a=t.getKey(r.key),s=t.setArrayIndex(a,o),n=t.parseExpression(s,t.model),i=n.get();_.each(e,function(e,r){i||(i=[]),i.push(r),n.set(i)})});var n=0,i=_.pluck(_.reject(e.items,{condition:"false"}),"key"),c=$rootScope.$on("flexFormArrayCopyAdded",function(r,a){var s=t.parseExpression(t.getKey(e.key),t.model).get();if(s){var c=s.length*i.length;if(_.includes(i,a)&&n++,n===c){for(var l=0;l<s.length;l++)o(null,null,"["+l+"]");n=0}}}),l=$rootScope.$on("flexForm.updatePage",function(){n=0});return t.events.push(c),t.events.push(l),o}function setupSelectDisplay(e,r,t){var o=function(){var o=t.getKey(r.key);_.each(e.items,function(e){var r=t.getKey(e.key),a=ObjectPath.parse(r);if(o!==r){var s=t.parseExpression(o,t.model).get();_.includes(s,a[a.length-1])?e.condition="true":(e.condition="false",t.parseExpression(r,t.model).set())}})},a=t.getKey(r.key),s=t.parseExpression(a,t.model),n=s.get();_.each(e.items,function(e){var r=t.getKey(e.key);if(a!==r){var o=ObjectPath.parse(r),i=t.parseExpression(r,t.model).get();i&&!_.includes(n,o[o.length-1])&&(n||(n=[]),n.push(o[o.length-1]),s.set(n))}});var i=t.getSchema(e.key)["default"];_.each(i,function(e,r){n||(n=[]),n.push(r),s.set(n)});var c=t.parseExpression(e.key,t.model);return i&&!c.get()&&c.set(i),o}function setupSchemaRefresh(e){var r=this;r.refreshSchema=_.debounce(function(t){var o,a=_.extend(cnFlexFormConfig.getStateParams(),r.params),s=cnUtil.diff(r.schema.params,a,!0);(s||t)&&(t?a.updateSchema=t:(o=_.keys(s),o.length>1&&(s=_.omit(s,_.isNull),o=_.keys(s)),a.updateSchema=_.first(o)),a.updateSchema||(s=cnUtil.diff(a,_.omit(r.schema.params,"updateSchema")),o=_.keys(s),a.updateSchema=_.first(o)),e(a).then(function(e){++r.updates,r.processUpdatedSchema(e)}))},100),r.refreshData=_.debounce(function(){e(_.extend(r.schema.params,{updateSchema:"refreshData"})).then(function(e){r.processUpdatedSchema(e),console.log("service.schema.params:",r.schema.params)})},100),r.events.push($rootScope.$on("ffRefreshData",r.refreshData))}function processUpdatedSchema(e){var r=this;if(e.diff){r.schema.params=e.params,e.diff.data&&_.each(e.diff.data,function(e,t){e.data&&!_.isEmpty(r.schema.data[t].data)&&(e.data=r.schema.data[t].data.concat(e.data)),r.schema.data[t]=e,r.resolveRegister[t]&&_.each(r.resolveRegister[t],function(e){r.handleResolve(e.field,e.key,"schema.data."+t)})});var t=[];e.diff.schema&&_.each(e.diff.schema,function(e,o){r.schema.schema.properties[o]=e,reprocessSchema(e,o,t)}),e.diff.form&&_.each(e.diff.form,function(e){-1===t.indexOf(e.key)&&t.push(e.key);var o=e.key;delete e.key;var a=r.getFromFormCache(o);a&&reprocessField(a,e);var s=r.getArrayCopies(o);s&&_.each(s,function(r){reprocessField(r,e)})}),t.length&&_.each(t,function(e){var t=r.getFromFormCache(e);if(t&&r.processField(t),e.includes("[]")){var o=r.getArrayCopies(e);_.each(o,function(e){e&&r.processField(e)})}}),r.broadcastErrors()}else r.updateSchema(e)}function reprocessField(e,r,t){_.extend(e,_.omit(r,"items","key")),_.each(e._ogKeys,function(t){r[t]||delete e[t]}),e._ogKeys=_.keys(r),!t&&e.redraw&&e.redraw()}function reprocessSchema(e,r,t){t.push(r),e.properties&&_.each(e.properties,function(e,o){reprocessSchema(e,r+"."+o,t)}),e.items&&e.items.properties&&_.each(e.properties,function(e,o){reprocessSchema(e,r+"[]."+o,t)})}function buildError(e){var r=this,t=r.getKey(e.key);return{key:t,message:e.error}}function broadcastErrors(){var e=this;$timeout(function(){e.errors.forEach(function(e){$rootScope.$broadcast("schemaForm.error."+e.key,"serverValidation",e.message)})},1)}function replaceArrayIndex(e,r){var t=/([^.]*)\[arrayIndex\]/.exec(e),o=new RegExp(t[1]+"\\[(\\d+)\\]"),a=o.exec(r);return e.replace(t[0],a[0])}function getArrayIndex(e){return _.isObject(e)?_.find(e.key,function(e){return _.isNumber(e)}):/\[(\d+)\]/.exec(e)[1]}function setArrayIndex(e,r,t){var o,a=this;o=_.isString(e)?ObjectPath.parse(e):_.clone(e);var s=o.indexOf("");return o[s]=r,t?o:a.getKey(o)}function cleanup(){var e=this;_.each(e.events,function(e){e()})}var services=[];return _.extend(CNFlexForm.prototype,{compile:compile,addArrayCopy:addArrayCopy,addToDataCache:addToDataCache,addToFormCache:addToFormCache,broadcastErrors:broadcastErrors,buildError:buildError,cleanup:cleanup,deregisterHandlers:deregisterHandlers,getArrayCopies:getArrayCopies,getArrayCopiesFor:getArrayCopiesFor,getFromDataCache:getFromDataCache,getFromFormCache:getFromFormCache,getKey:getKey,getSchema:getSchema,handleResolve:handleResolve,initArrayCopyWatch:initArrayCopyWatch,initModelWatch:initModelWatch,initSchemaParams:initSchemaParams,isCompiled:isCompiled,isConditionFunction:isConditionFunction,onModelWatch:onModelWatch,parseCondition:parseCondition,parseExpression:parseExpression,processDefault:processDefault,processDisplay:processDisplay,processField:processField,processFieldset:processFieldset,processFieldWatch:processFieldWatch,processComponent:processComponent,processCurrency:processCurrency,processPercentage:processPercentage,processDate:processDate,processHelp:processHelp,processRadiobuttons:processRadiobuttons,processReusable:processReusable,processSchema:processSchema,processSelectDisplay:processSelectDisplay,processResolve:processResolve,processSection:processSection,processSelect:processSelect,processTemplate:processTemplate,processToggle:processToggle,processUpdatedSchema:processUpdatedSchema,processMediaUpload:processMediaUpload,registerArrayHandlers:registerArrayHandlers,registerHandler:registerHandler,registerResolve:registerResolve,setArrayIndex:setArrayIndex,setupConfig:setupConfig,setupSchemaRefresh:setupSchemaRefresh}),CNFlexFormConstructor}angular.module("cn.flex-form").provider("cnFlexFormService",cnFlexFormServiceProvider);var fieldTypeHandlers={"cn-radiobuttons":"processRadiobuttons","cn-autocomplete":"processSelect","cn-datetimepicker":"processDate",help:"processHelp","cn-display":"processDisplay","cn-currency":"processCurrency","cn-percentage":"processPercentage","cn-mediaupload":"processMediaUpload","cn-reusable":"processReusable","cn-toggle":"processToggle",section:"processSection"};cnFlexFormServiceProvider.$inject=["schemaFormDecoratorsProvider","cnFlexFormTypesProvider"],CNFlexFormService.$inject=["Api","$parse","cnFlexFormConfig","cnFlexFormTypes","$interpolate","$rootScope","$timeout","cnUtil"]}(),function(){function e(){function e(){console.log("FlexFormSandbox")}function r(){if(t.schemaStr){var e=angular.fromJson(t.schemaStr);console.log("schema:",e),!e.form&&e.forms&&(e.form=e.forms[0].form),t.config.schema=e.form&&e}}var t=this;t.activate=e,t.onSchema=r,t.model={},t.config={},t.schemaStr="",e()}angular.module("cn.flex-form").controller("FlexFormSandbox",e)}(),function(){function e(e){var r=["cn-fieldset","cn-toggle","cn-datetimepicker","cn-autocomplete","cn-autocomplete-detailed","cn-currency","cn-radiobuttons","cn-percentage","cn-display","cn-mediaupload","cn-reusable"];_.each(r,function(r){e.registerField({type:r,templateUrl:"app/components/cn-flex-form/forms/"+r+".html"})})}function r(e){e.put("app/components/cn-flex-form/forms/cn-toggle.html",'        <div class="form-group {{form.htmlClass}}"              ng-class="{\'has-error\': hasError(), \'has-success\': hasSuccess()}">          <label class="control-label" ng-show="showTitle()">{{form.title}}</label>          <div class="clearfix">            <cn-toggle-switch              class="pull-left"              ng-show="form.key"              enabled="$$value$$"              on-value="angular.isDefined(form.onValue) ? form.onValue : true"              off-value="angular.isDefined(form.offValue) ? form.offValue : false">            </cn-toggle-switch>            <span ng-show="form.onText && form.offText">              {{$$value$$ === form.onValue ? form.onText : form.offText}}            </span>          </div>          <span class="help-block" sf-message="form.description"></span>        </div>        '),e.put("app/components/cn-flex-form/forms/cn-datetimepicker.html",'        <div class="form-group {{form.htmlClass}}"             ng-class="{\'has-error\': hasError(), \'has-success\': hasSuccess()}">          <label class="control-label"                 for="{{form.key.join(\'.\')}}"                 ng-show="showTitle()">{{form.title}}</label>          <cn-datetimepicker            ng-show="form.key"            ng-model="$$value$$"            ng-model-options="form.ngModelOptions"            is-disabled="form.readonly"            sf-changed="form"            schema-validate="form"            input-id="{{form.key.join(\'.\')}}"            min-date="form.minDate"            required="form.required"            model-type="{{form.schema.type}}">          </cn-datetimepicker>          <span class="help-block" sf-message="form.description"></span>        </div>        ');var r='          <tags-input            ng-show="form.key"            ng-model="$$value$$"            ng-model-options="form.ngModelOptions"            ng-disabled="form.readonly"            sf-changed="form"            schema-validate="form"            input-id="{{form.key.join(\'.\')}}"            display-property="{{form.displayProperty || \'name\'}}"            value-property="{{form.valueProperty || \'value\'}}"            placeholder="{{form.placeholder || \' \'}}"            add-on-blur="true"            add-on-comma="false"            add-from-autocomplete-only="{{!form.allowNew}}"            on-before-tag-added="form.onAdd({value: $tag}, form, $event, $prev)"            on-init="form.onInit($tag, form, $event, $setter)"            model-type="{{form.getSchemaType()}}"            array-value-type="{{form.schema.items.type}}"            hide-tags="{{form.detailedList}}"            tags-style="{{form.selectionStyle}}"            required="{{form.required}}"            min-length="{{form.minLength}}"            allowed-tags-pattern=".*"            dropdown="true"            item-formatter="form.itemFormatter"            min-tags="{{form.schema.minItems}}"            max-tags="{{form.schema.maxItems || form.getSchemaType() !== \'array\' ? 1 : 0}}"            allow-bulk="{{form.bulkAdd}}"            bulk-delimiter="{{form.bulkDelimiter}}"            bulk-placeholder="{{form.bulkPlaceholder}}"            show-button="true">            <auto-complete              source="form.getTitleMap && form.getTitleMap() || form.titleQuery($query)"              skip-filtering="{{form.titleQuery ? true : false}}"              min-length="{{form.minLookup || (form.titleQuery && 3 || 0)}}">            </auto-complete>          </tags-input>          ';
e.put("app/components/cn-flex-form/forms/cn-autocomplete.html",'        <div class="form-group {{form.htmlClass}}"             ng-class="{\'has-error\': hasError(), \'has-success\': hasSuccess()}">          <label class="control-label"                 for="{{form.key.join(\'.\')}}-input"                 ng-show="showTitle()">{{form.title}}</label>          '+r+'          <span class="help-block" sf-message="form.description"></span>        </div>        '),e.put("app/components/cn-flex-form/forms/cn-autocomplete-detailed.html",'        <div sf-array="form"             class="form-group {{form.htmlClass}}"             ng-class="{\'has-error\': hasError(), \'has-success\': hasSuccess()}">          <label class="control-label"                 for="{{form.key.join(\'.\')}}-input"                 ng-show="showTitle()">{{form.title}}</label>          <ol class="list-group cn-autocomplete-list"              ng-show="modelArray.length"              ng-model="modelArray">            <li class="list-group-item {{form.fieldHtmlClass}}"                ng-repeat="item in modelArray track by $index">              <button ng-hide="form.readonly || form.remove === null"                      ng-click="deleteFromArray($index)"                      type="button" class="close pull-right">                <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>              </button>              <sf-decorator ng-init="arrayIndex = $index" form="copyWithIndex($index)"></sf-decorator>            </li>          </ol>          '+r+'          <span class="help-block" sf-message="form.description"></span>        </div>        '),e.put("app/components/cn-flex-form/forms/cn-currency.html",'        <div class="form-group {{form.htmlClass}}"             ng-class="{\'has-error\': hasError(), \'has-success\': hasSuccess()}">          <label class="control-label"                 ng-show="showTitle()"                 for="{{form.key.join(\'.\')}}">{{form.title}}</label>          <div class="{{form.fieldClass}} input-group">            <label class="input-group-addon"                   ng-disabled="form.readonly"                   for="{{form.key.join(\'.\')}}">$</label>            <input class="form-control"                   cn-currency-format="{{form.currencyFormat}}"                   ng-show="form.key"                   ng-model-options="form.ngModelOptions"                   ng-disabled="form.readonly"                   sf-changed="form"                   schema-validate="form"                   ff-validate="form"                   type="text"                   step="any"                   min="{{form.min}}"                   max="{{form.max}}"                   id="{{form.key.join(\'.\')}}"                   name="{{form.key.join(\'.\')}}"                   ng-model="$$value$$">          </div>          <span class="help-block" sf-message="form.description"></span>        </div>        '),e.put("app/components/cn-flex-form/forms/cn-radiobuttons.html",'        <div class="form-group schema-form-radiobuttons cn-radiobuttons {{form.htmlClass}}"             ng-class="{\'has-error\': hasError(), \'has-success\': hasSuccess()}">          <label class="control-label" ng-show="showTitle()">{{form.title}}</label>          <div class="btn-group clearfix">            <label class="btn btn-{{item.value}} {{form.btnClass}} {{item.value === $$value$$ ? \'active\' : \'\'}}"                   ng-repeat="item in form.titleMap">              <input type="radio"                     class="{{form.fieldHtmlClass}} hide"                     sf-changed="form"                     ng-disabled="form.readonly"                     ng-model="$$value$$"                     ng-model-options="form.ngModelOptions"                     schema-validate="form"                     ff-validate="form"                     ng-value="item.value"                     name="{{form.key.join(\'.\')}}">              <i class="fa fa-{{item.value}} fa-lg"></i>              <span ng-bind-html="item.name"></span>            </label>          </div>          <span class="help-block" sf-message="form.description"></span>        </div>        '),e.put("app/components/cn-flex-form/forms/cn-percentage.html",'        <div class="form-group {{form.htmlClass}}"             ng-class="{\'has-error\': hasError(), \'has-success\': hasSuccess()}">          <label class="control-label"                 ng-show="showTitle()"                 for="{{form.key && form.key[0]}}">{{form.title}}</label>          <div class="{{form.fieldClass}} input-group">            <input class="form-control"                   cn-percentage-format                   ng-show="form.key"                   ng-model-options="form.ngModelOptions"                   ng-disabled="form.readonly"                   sf-changed="form"                   schema-validate="form"                   type="number"                   step="any"                   min="{{form.min}}"                   max="{{form.max}}"                   id="{{form.key && form.key[0]}}"                   name="{{form.key && form.key[0]}}"                   ng-model="$$value$$">             <div class="input-group-addon"                    ng-disabled="form.readonly"                    for="{{form.key && form.key[0]}}">%</div>          </div>          <span class="help-block" sf-message="form.description"></span>        </div>        '),e.put("app/components/cn-flex-form/forms/cn-display.html",'        <div class="form-group cn-display{{form.htmlClass}}">          <input ng-show="form.key"                 class="form-control"                 id="{{form.key.join(\'.\')}}"                 name="{{form.key.join(\'.\')}}"                 ng-disabled="true"                 value="{{form.getDisplay(form.key, form.arrayIndex)}}">        </div>        '),e.put("app/components/cn-flex-form/forms/cn-fieldset.html",'        <fieldset ng-disabled="form.readonly" class="schema-form-fieldset {{form.htmlClass}}">          <legend ng-click="form.toggleCollapse()"                  ng-class="{\'sr-only\': !showTitle(), collapsible: form.collapsible}"                  ng-mouseenter="form.render = true">            <i ng-show="form.collapsible"               class="fa fa-caret-{{form.collapsed ? \'right\' : \'down\'}}"></i>            {{ form.title }}          </legend>          <div class="help-block" ng-show="form.description" ng-bind-html="form.description"></div>          <div collapse="form.collapsed">            <div ng-if="form.render">              <sf-decorator ng-repeat="item in form.items" form="item"></sf-decorator>            </div>          </div>        </fieldset>        '),e.put("app/components/cn-flex-form/forms/cn-mediaupload.html",'        <div class="form-group {{form.htmlClass}}"             ng-class="{\'has-error\': hasError(), \'has-success\': hasSuccess()}">          <label class="control-label"                 ng-show="showTitle()"                 for="{{form.key && form.key[0]}}">{{form.title}}</label>          <media-upload ng-model="$$value$$"                        cn-file-type="form.fileType"                        cn-upload-path="form.uploadPath"                        cn-data="form.data"                        cn-preview-path="form.previewPath"                        cn-model-value-key="form.modelValueKey"                        ng-model-options="form.ngModelOptions"                        sf-changed="form"                        schema-validate="form"                        ff-form="form"                        class="clearfix">          </media-upload>          <span class="help-block" sf-message="form.description"></span>       </div>        '),e.put("app/components/cn-flex-form/forms/cn-reusable.html",'        <div class="form-group cn-reusable {{form.htmlClass}}"             ng-class="{\'has-error\': hasError(), \'has-success\': hasSuccess()}">          <label class="control-label"                 ng-show="showTitle()"                 for="{{form.key.join(\'.\')}}">{{form.title}}</label>          <cn-select-or            ng-show="form.key"            select-from="form.library"            ng-model="$$value$$"            ng-model-options="form.ngModelOptions"            sf-changed="form"            schema-validate="form"            ff-form="form"            directiveId="form.directiveId"            item-template="form.itemTemplate"            toggle-text="form.toggleText"            disabled="form.readonly"            view="form.view">            <sf-decorator ng-repeat="item in form.items" form="item"/>          </cn-select-or>          <p ng-if="form.loadMore && form.view === \'list\'">            <a ng-click="form.loadMore()"               class="btn btn-default btn-block">Load More</a>          </p>          <span class="help-block" sf-message="form.description"></span>        </div>        ')}angular.module("cn.flex-form").config(e).run(r),e.$inject=["cnFlexFormServiceProvider"],r.$inject=["$templateCache"]}();
//# sourceMappingURL=all.min.js.map
